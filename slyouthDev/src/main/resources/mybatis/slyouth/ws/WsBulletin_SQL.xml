<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ws.bulletin">
	
	<!-- 주보를 리스트로 조회하는 쿼리문입니다. -->
	<select id="bulletinList" resultType="WsBulletinDVO">
	
	<include refid="cm.com.pagingTop" />
	
	<![CDATA[
		SELECT A.CMNTY_NO			/* 커뮤니티번호 */
			 , A.TITLE				/* 제목 */
			 , A.CONTENT			/* 내용 */
		     , A.LST_MDF_DT			/* 최종수정일시 */
		     , A.VIEW_CNT 			/* 조회수 */
		     , B.NAME				/* 이름 */
		     , C.FILE_NO			/* 파일번호 */
		  FROM TB_CMNTY AS A 
	INNER JOIN TB_CHRMGNT AS B
			ON A.LST_MDF_NO = B.CHR_NO
	 LEFT JOIN TB_FILE C
		    ON A.CMNTY_DIV_CD = C.REF_DIV_CD
		   AND A.CMNTY_NO = C.REF_NO
		   AND C.REF_TB_KEY = #{slyouthTbKey}
		 WHERE A.CMNTY_DIV_CD = 'BLT'
	]]>
	  
	<if test="title != null and title != ''">
		   <!-- 제목 -->
		   AND A.TITLE LIKE CONCAT('%', #{title}, '%')
	</if>
	
	<if test="name != null and name != ''">
		   <!-- 작성자 -->
		   AND B.NAME LIKE CONCAT('%', #{name}, '%')	
	</if>
	  ORDER BY A.LST_MDF_DT DESC
	     LIMIT 100000
	  
	<include refid="cm.com.pagingBottom" />
	
	</select>
	
	<!-- 주보 목록의 수를 조회하는 쿼리입니다. -->
	<select id="selectBulletinTotalDataCnt" parameterType="WsBulletinDVO" resultType="int">
	<![CDATA[
		SELECT COUNT(*)
		  FROM TB_CMNTY AS A 
	INNER JOIN TB_CHRMGNT AS B
			ON A.LST_MDF_NO = B.CHR_NO
	 LEFT JOIN TB_FILE C
		    ON A.CMNTY_DIV_CD = C.REF_DIV_CD
		   AND A.CMNTY_NO = C.REF_NO
		   AND C.REF_TB_KEY = #{slyouthTbKey}
		 WHERE A.CMNTY_DIV_CD = 'BLT'
	]]>
	
	<if test="title != null and title != ''">
		   <!-- 제목 -->
		   AND A.TITLE LIKE CONCAT('%', #{title}, '%')
	</if>

	<if test="name != null and name != ''">
		   <!-- 작성자 -->
		   AND B.NAME LIKE CONCAT('%', #{name}, '%')	
	</if>

	</select>
	
	<!-- 주보를 등록하는 쿼리입니다.(커뮤니티구분코드: NTC, 작성구분코드: BLT) -->
	<insert id="bulletinRegist" parameterType="WsBulletinDVO">
	<![CDATA[
		INSERT 
		  INTO TB_CMNTY
			   (	
			   		TITLE				/* 제목 */
			   		, CONTENT			/* 내용 */
			   		, FRS_REG_NO		/* 최초등록자 */
			   		, LST_MDF_NO		/* 최종수정자 */
			   		, CMNTY_DIV_CD		/* 커뮤니티구분코드 */
			   		, GRP_NO			/* 그룹번호 */
			   		, CMNTY_MNG_NO		/* 커뮤니티관리번호 */		
			   	)
		VALUES	(
					#{title}
					, #{content}
					, '1'
					, '1'
					, 'BLT'
					, '0'
					, (
					   SELECT CMNTY_MNG_NO
					     FROM TB_CMNTY_MNG
					    WHERE CMNTY_DIV_CD = 'BLT'
					   )
				)
	]]>
	<selectKey keyProperty="cmntyNo" resultType="int" order="AFTER">
		SELECT LAST_INSERT_ID()
	</selectKey>
	</insert>
	
	<!-- 주보를 수정할 수 있습니다. -->
	<update id="bulletinUpdate" parameterType="WsBulletinDVO">
	<![CDATA[
		UPDATE TB_CMNTY
		   SET TITLE = #{title} 		/* 제목 */
		   	 , CONTENT = #{content}		/* 내용 */
		   	 , LST_MDF_DT = NOW()		/* 최종수정일시 */
		 WHERE CMNTY_NO = #{cmntyNo}
		   AND CMNTY_DIV_CD = 'BLT';
	]]>
	</update>
	
	<!-- 커뮤니티 번호에 맞는 주보를 상세조회할 수 있는 쿼리입니다. -->
	<select id="bulletinDetail" parameterType="WsBulletinDVO" resultType="WsBulletinDVO">
	<![CDATA[
		SELECT A.CMNTY_NO			/* 커뮤니티번호 */
			 , A.TITLE				/* 제목 */
			 , A.CONTENT			/* 내용 */
		     , A.LST_MDF_DT			/* 최종수정일시 */
		     , A.VIEW_CNT 			/* 조회수 */
		     , B.NAME				/* 이름 */
		     , C.FILE_NO			/* 파일번호 */
		  FROM TB_CMNTY AS A 
	INNER JOIN TB_CHRMGNT AS B
			ON A.LST_MDF_NO = B.CHR_NO
	 LEFT JOIN TB_FILE C
		    ON A.CMNTY_DIV_CD = C.REF_DIV_CD
		   AND A.CMNTY_NO = C.REF_NO
		   AND C.REF_TB_KEY = #{slyouthTbKey}
		 WHERE A.CMNTY_DIV_CD = 'BLT'
		   AND A.CMNTY_NO = #{cmntyNo}
	]]>		
	</select>
	
	<!-- 주보를 상세조회할 때마다 조회수를 1씩 증가시키는 쿼리입니다. -->
	<update id="bulletinViewCnt" parameterType="WsBulletinDVO">
	<![CDATA[
		UPDATE TB_CMNTY
		   SET VIEW_CNT = VIEW_CNT + 1 /* 조회수 */
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>
	</update>
	
	<!-- 주보 첨부파일 조회 쿼리입니다. -->
	<select id="selectBulletinFile" parameterType="WsBulletinDVO" resultType="WsBulletinDVO">
	<![CDATA[
		SELECT B.FILE_NO		/* 파일번호 */
			 , B.FILE_NM		/* 파일이름 */
		  FROM TB_CMNTY A
	 LEFT JOIN TB_FILE B
		    ON A.CMNTY_DIV_CD = B.REF_DIV_CD
		   AND A.CMNTY_NO = B.REF_NO
		   AND B.REF_TB_KEY = #{slyouthTbKey}
		 WHERE A.CMNTY_NO = #{cmntyNo}
	]]>
	</select>
	
	<!-- 커뮤니티 번호에 맞는 주보를 교역자, 임원에 한에서 삭제할 수 있는 쿼리입니다. -->
	<delete id="bulletinDelete" parameterType="WsBulletinDVO">
	<![CDATA[
		DELETE FROM
			   TB_CMNTY
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>	
	</delete>
</mapper>