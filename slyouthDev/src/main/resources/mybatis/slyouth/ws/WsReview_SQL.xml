<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ws.review">
	
	<!-- 말씀후기 리스트를 조회하는 쿼리문입니다. -->
	<select id="reviewList" parameterType="WsReviewDVO" resultType="WsReviewDVO">
	
	<include refid="cm.com.pagingTop" />
	
	<![CDATA[
		SELECT A.CMNTY_NO			/* 커뮤니티번호 */
			 , A.TITLE				/* 제목 */
			 , A.CONTENT			/* 내용 */
		     , A.LST_MDF_DT			/* 최종수정일시 */
		     , A.VIEW_CNT 			/* 조회수 */
		     , B.NAME				/* 이름 */
		     , C.FILE_NO			/* 파일번호 */
		  FROM TB_CMNTY AS A 
	INNER JOIN TB_CHRMGNT AS B
			ON A.LST_MDF_NO = B.CHR_NO
	 LEFT JOIN TB_FILE C
		    ON A.CMNTY_DIV_CD = C.REF_DIV_CD
		   AND A.CMNTY_NO = C.REF_NO
		 WHERE A.CMNTY_DIV_CD = 'WRE'
	]]>
	  
	<if test="title != null and title != ''">
	<!-- 제목 -->
		   AND A.TITLE LIKE CONCAT('%', #{title}, '%')
	</if>
	
	<if test="content != null and content != ''">
	<!-- 내용 -->
		   AND A.CONTENT LIKE CONCAT('%', #{content}, '%')	
	</if>
	
	<if test="name != null and name != ''">
	<!-- 작성자 -->
		   AND B.NAME LIKE CONCAT('%', #{name}, '%')	
	</if>
	  ORDER BY A.LST_MDF_DT DESC
	     LIMIT 100000
	  
	<include refid="cm.com.pagingBottom" />
	
	</select>
	
	<!-- 말씀후기 목록의 수를 조회하는 쿼리입니다. -->
	<select id="reviewListTotalCnt" parameterType="WsReviewDVO" resultType="int">
	<![CDATA[
		SELECT COUNT(*)
		  FROM TB_CMNTY AS A 
	INNER JOIN TB_CHRMGNT AS B
			ON A.LST_MDF_NO = B.CHR_NO
	 LEFT JOIN TB_FILE C
		    ON A.CMNTY_DIV_CD = C.REF_DIV_CD
		   AND A.CMNTY_NO = C.REF_NO
		 WHERE A.CMNTY_DIV_CD = 'WRE'
	]]>
	
	<if test="title != null and title != ''">
	<!-- 제목 -->
		   AND A.TITLE LIKE CONCAT('%', #{title}, '%')
	</if>
	
	<if test="content != null and content != ''">
	<!-- 내용 -->
		   AND A.CONTENT LIKE CONCAT('%', #{content}, '%')	
	</if>
	
	<if test="name != null and name != ''">
	<!-- 작성자 -->
		   AND B.NAME LIKE CONCAT('%', #{name}, '%')	
	</if>

	</select>
	
	<!-- 말쓰후기를 등록하는 쿼리입니다 -->
	<insert id="insertReview" parameterType="WsReviewDVO">
		
	<![CDATA[
		INSERT INTO TB_CMNTY
			   (	
			   		TITLE				/* 제목 */
			   		, CONTENT			/* 내용 */
			   		, FRS_REG_NO		/* 최초등록자 */
			   		, LST_MDF_NO		/* 최종수정자 */
			   		, TSK_DIV_CD		/* 업무구분코드 */
			   		, CMNTY_DIV_CD		/* 커뮤니티구분코드 */
			   		, GRP_NO			/* 그룹번호 */
			   	)
		VALUES	(
					#{title}
					, #{content}
					, '1'
					, '1'
					, 'WS'
					, 'WRE'
					, '0'
				)
	]]>
	</insert>
		
	<!-- 말씀후기를 수정할 수 있습니다. -->
	<update id="updateReview" parameterType="WsReviewDVO">
	<![CDATA[
		UPDATE TB_CMNTY
		   SET TITLE = #{title} 		/* 제목 */
		   	 , CONTENT = #{content}		/* 내용 */
		   	 , LST_MDF_DT = NOW()		/* 최종수정일시 */
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>
	</update>
	
	<!-- 말씀후기 상세조회할 수 있는 쿼리입니다. -->
	<select id="reviewDetail" parameterType="WsReviewDVO" resultType="WsReviewDVO">
	<![CDATA[
		SELECT A.CMNTY_NO			/* 커뮤니티번호 */
			 , A.TITLE				/* 제목 */
			 , A.CONTENT			/* 내용 */
		     , A.LST_MDF_DT			/* 최종수정일시 */
		     , A.VIEW_CNT 			/* 조회수 */
		     , B.NAME				/* 이름 */
		     , C.FILE_NO			/* 파일번호 */
		  FROM TB_CMNTY AS A 
	INNER JOIN TB_CHRMGNT AS B
			ON A.LST_MDF_NO = B.CHR_NO
	 LEFT JOIN TB_FILE C
		    ON A.CMNTY_DIV_CD = C.REF_DIV_CD
		   AND A.CMNTY_NO = C.REF_NO
		 WHERE A.CMNTY_DIV_CD = 'WRE'
		   AND CMNTY_NO = #{cmntyNo}
	]]>		
	</select>
	
	<!-- 말씀후기를 상세조회할 때마다 조회수를 1씩 증가시키는 쿼리입니다. -->
	<update id="reviewCnt" parameterType="WsReviewDVO">
	<![CDATA[
		UPDATE TB_CMNTY
		   SET VIEW_CNT = VIEW_CNT + 1 /* 조회수 */
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>
	</update>
	
	<!-- 커뮤니티 번호에 맞는 말씀후기를 교역자, 임원에 한에서 삭제할 수 있는 쿼리입니다. -->
	<delete id="deleteReview" parameterType="WsReviewDVO">
	<![CDATA[
		DELETE FROM
			   TB_CMNTY
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>	
	</delete>
</mapper>