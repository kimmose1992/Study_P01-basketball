<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="nm.bookList">
	
	<!-- 새가족교재(NMB) 목록 조회 -->
	<select id="nmBookList" parameterType="NmBookDVO" resultType="NmBookDVO">
	<include refid="cm.com.pagingTop" />
	
	<![CDATA[
		SELECT A.CMNTY_NO					/* 커뮤니티번호*/
			 , A.TITLE						/* 제목 */
			 , A.CONTENT					/* 내용 */
			 , A.FRS_REG_DT               	/* 최초등록일시 */
             , A.LST_MDF_DT             	/* 최종수정일시 */
             , A.VIEW_CNT               	/* 조회수 */
			 , A.CMNTY_DIV_CD            	/* 커뮤니티구분코드 */
             , A.WRT_DIV_CD               	/* 글구분코드 */
             , A.FRS_REG_NO              	/* 최초등록자번호 */
             , A.LST_MDF_NO            		/* 최종수정자번호*/
             , B.CHR_NO 					/* 교적번호 */
             , B.NAME						/* 이름 */
		  FROM TB_CMNTY AS A
	INNER JOIN TB_CHRMGNT AS B
			ON A.FRS_REG_NO = B.CHR_NO
           AND A.CMNTY_DIV_CD = "NMB"	
      ORDER BY A.FRS_REG_DT DESC LIMIT 10000
	]]>	
	
	<if test="title != null and title != ''">
    <!-- 제목 -->   
      AND TITLE LIKE CONCAT('%', #{title}, '%')
    </if>
	<include refid="cm.com.pagingBottom" />
	</select>

	<!-- 새가족교재(NMB) 상세조회 -->
   	<select id="nmBookDetail" parameterType="NmBookDVO" resultType="NmBookDVO">
   	<![CDATA[ 
   		 SELECT A1.CMNTY_NO              	/* 커뮤니티번호*/
              , A1.TITLE                 	/* 제목 */
              , A1.CONTENT               	/* 내용 */
              , A1.FRS_REG_DT            	/* 최초등록일시 */
              , A1.LST_MDF_DT            	/* 최종수정일시 */
              , A1.VIEW_CNT              	/* 조회수 */
              , A1.TOP_FIX_YN            	/* 상단고정여부 */
              , A1.CMNTY_DIV_CD          	/* 커뮤니티구분코드 */
              , A1.WRT_DIV_CD            	/* 글구분코드 */
              , A1.FRS_REG_NO            	/* 최초등록자번호 */
              , A1.LST_MDF_NO				/* 최종수정자번호*/
              , A2.CHR_NO 					/* 교적번호 */
              , A2.NAME						/* 이름 */						
           FROM TB_CMNTY AS A1
	 INNER JOIN TB_CHRMGNT AS A2
	         ON A1.FRS_REG_NO = A2.CHR_NO 	
          WHERE A1.CMNTY_DIV_CD = "NMB"
            AND A1.CMNTY_NO = #{cmntyNo}
	]]>
	</select>
	
	<!-- 새가족교재(NMB) 목록 갯수 조회 -->
   	<select id="selectBookTotalCnt" parameterType="NmBookDVO" resultType="int">
   	<![CDATA[
 		 SELECT COUNT (*)
           FROM TB_CMNTY
          WHERE CMNTY_DIV_CD = "NMB"
	]]>
	
	<if test="title != null and title != ''">
    <!-- 제목 -->   
		AND TITLE LIKE CONCAT('%', #{title}, '%')
    </if>
	</select>
	
	<!-- 새가족교재(NMB) 조회수 증가 -->
	<update id="nmBookCnt" parameterType="int">
	<![CDATA[
		UPDATE TB_CMNTY
		   SET VIEW_CNT = VIEW_CNT + 1			/* 조회수 */
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>
	</update>
	
	<!-- 새가족교재(NMB) 게시글 삭제 -->
	<delete id="nmBookDelete" parameterType="int">
	<![CDATA[
		DELETE FROM 
			   TB_CMNTY
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>
	</delete>
	
	
	<!-- 새가족교재(NMB) 글 등록 -->
	<insert id="nmBookInsert"  parameterType="NmBookDVO">
	<![CDATA[
		INSERT
		  INTO TB_CMNTY
		  	   (	
		  	    TITLE				/* 제목 */
		  	  , CONTENT				/* 내용 */	
			  , VIEW_CNT			/* 조회수 */ 
			  , CMNTY_DIV_CD		/* 커뮤니티구분코드 */
			  , WRT_DIV_CD			/* 글구분코드 */
			  , FRS_REG_NO			/* 최초등록자 */
			  , LST_MDF_NO			/* 최종수정자 */
			  , FRS_REG_DT			/* 최초등록일시 */
			  , LST_MDF_DT			/* 최종수정일시*/
			   )
		VALUES (	
				#{title}			
			  , #{content}
			  , #{viewCnt}
			  , 'NMB'
			  , 'NMB'
			  , '1'			  
			  , #{lstMdfNo}
			  , NOW()
			  , NOW()
			   )  
		]]>
	<selectKey keyProperty="cmntyNo" resultType="int">
        SELECT LAST_INSERT_ID()
    </selectKey>
	</insert>
	
	<!-- 새가족교재(NMB) 수정 -->
	<update id="nmBookUpdate" parameterType="NmBookDVO">
	<![CDATA[
		UPDATE TB_CMNTY
		   SET TITLE = #{title}					/* 제목 */		
		     , CONTENT = #{content}				/* 내용 */
		   	 , LST_MDF_DT = NOW()				/* 최종수정일시 */
		   	 , LST_MDF_NO = #{lstMdfNo}					/* 최종수정자 */
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>
	</update>
	
</mapper>