<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="nt.circle">

	<!-- 동아리 리스트 조회 -->
	<select id="circleList" parameterType="NtCircleDVO" resultType="NtCircleDVO">
	<include refid="cm.com.pagingTop" />	
	
		<![CDATA[
			SELECT A.EVENT_NO				/* 행사번호 */
			     , A.EVENT_DIV_CD			/* 행사구분코드 */
			     , A.EVENT_NM				/* 행사명 */
			     , A.EVENT_INTRO			/* 행사소개 */
			     , A.REP_IMG_NO			/* 행사이미지 번호 */
			     , A.MNG_NO					/* 담당자 번호 */
			     , C.NAME					/* 담당자 이름 */
			     , (
			       		SELECT COUNT(*)
			          	  FROM TB_EVENT S1
			      	INNER JOIN TB_EVENT_APP S2
			      	        ON S1.EVENT_NO = S2.EVENT_NO
			      	     WHERE S2.APP_YN = 'Y'
			      	       AND A.EVENT_NO = S1.EVENT_NO
			       ) PEOPLE_NUM 			/* 인원 수 */
			     , A.STR_YMD				/* 시작일자 */
			     , A.STR_TM					/* 시작시각 */
			     , A.PLACE					/* 장소 */
			     , A.FRS_REG_NO				/* 최초등록자번호 */
			     , A.FRS_REG_DT				/* 최초등록일시 */
			     , A.LST_MDF_NO				/* 최종수정자번호 */
			     , A.LST_MDF_DT				/* 최종수정일시 */
			  FROM TB_EVENT A
   LEFT OUTER JOIN TB_FILE B
	   			ON A.EVENT_NO = B.REF_NO
	   		   AND A.EVENT_DIV_CD = B.REF_DIV_CD
	   		   AND B.REF_TB_KEY = #{slyouthTbKey}
	   	INNER JOIN TB_CHRMGNT C
	   	        ON C.CHR_NO = A.MNG_NO
		 	 WHERE A.EVENT_DIV_CD = 'CIR'
		 	   AND A.REP_IMG_NO = B.FILE_NO
		  ORDER BY A.FRS_REG_DT DESC
		]]>
	
		<if test="eventNm != null and eventNm != ''">
		<!-- 동아리 이름 -->
	   		   AND A.EVENT_NM LIKE CONCAT('%', #{eventNm}, '%')
		</if>
	
	<include refid="cm.com.pagingBottom" />
	</select>
	
	<!-- 동아리 리스트 갯수 조회 -->
	<select id="selectCircleTotalCnt" parameterType="NtCircleDVO" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			  FROM TB_EVENT A
   LEFT OUTER JOIN TB_FILE B
	   			ON A.EVENT_NO = B.REF_NO
	   		   AND A.EVENT_DIV_CD = B.REF_DIV_CD
	   		   AND B.REF_TB_KEY = #{slyouthTbKey}
	   	INNER JOIN TB_CHRMGNT C
	   	        ON C.CHR_NO = A.MNG_NO
		 	 WHERE A.EVENT_DIV_CD = 'CIR'
		 	   AND A.REP_IMG_NO = B.FILE_NO
		]]>
	
		<if test="eventNm != null and eventNm != ''">
		<!-- 동아리 이름 -->
	   		   AND A.EVENT_NM LIKE CONCAT('%', #{eventNm}, '%')
		</if>
	</select>
	
	<!-- 동아리 메인 사진 정보수정 -->
	<update id="updateCircleThumbNo"  parameterType="NtCircleDVO">
		<![CDATA[
			UPDATE TB_EVENT
			   SET REP_IMG_NO = #{fileNo}		/* 행사이미지번호 */	
			 WHERE EVENT_NO = #{eventNo};
		]]>
	</update>
	
	<!-- 동아리 상세 조회 -->
	<select id="selectCircleInfo" parameterType="NtCircleDVO" resultType="NtCircleDVO">
		<![CDATA[
			SELECT A.EVENT_NO				/* 행사번호 */
			     , A.EVENT_DIV_CD			/* 행사구분코드 */
			     , A.EVENT_NM				/* 행사명 */
			     , A.EVENT_INTRO			/* 행사소개 */
			     , A.REP_IMG_NO			/* 행사이미지 번호 */
			     , A.MNG_NO					/* 담당자 번호 */
			     , C.NAME					/* 담당자 이름 */
			     , (
			       		SELECT COUNT(*)
			          	  FROM TB_EVENT S1
			      	INNER JOIN TB_EVENT_APP S2
			      	        ON S1.EVENT_NO = S2.EVENT_NO
			      	     WHERE S2.APP_YN = 'Y'
			      	       AND A.EVENT_NO = S1.EVENT_NO
			       ) PEOPLE_NUM 			/* 인원 수 */
			     , A.STR_YMD				/* 시작일자 */
			     , A.STR_TM					/* 시작시각 */
			     , A.END_YMD				/* 종료일자 */
			     , A.END_TM					/* 종료시각 */
			     , A.PLACE					/* 장소 */
			     , A.REMARK					/* 비고 */
			     , A.APP_STR_YMD			/* 신청시작일자 */
			     , A.APP_STR_TM				/* 신청시작시각 */
			     , A.APP_END_YMD			/* 신청종료일자 */
			     , A.APP_END_TM				/* 신청종료시각 */
			     , A.FRS_REG_NO				/* 최초등록자번호 */
			     , A.FRS_REG_DT				/* 최초등록일시 */
			     , A.LST_MDF_NO				/* 최종수정자번호 */
			     , A.LST_MDF_DT				/* 최종수정일시 */
				 , B.FILE_NM				/* 파일이름 */
			  FROM TB_EVENT A
   		INNER JOIN TB_FILE B
	   			ON A.EVENT_NO = B.REF_NO
	   		   AND A.EVENT_DIV_CD = B.REF_DIV_CD
	   		   AND B.REF_TB_KEY = #{slyouthTbKey}
	   		   AND A.REP_IMG_NO = B.FILE_NO
	    INNER JOIN TB_CHRMGNT C
	   	        ON C.CHR_NO = A.MNG_NO
		 	 WHERE A.EVENT_DIV_CD = 'CIR'
		 	   AND A.EVENT_NO = #{eventNo}
		]]>	
	</select>
	
	<!-- 동아리 상세 첨부파일 갯수 조회 -->
	<select id="selectCircleFileTotalCnt" parameterType="NtCircleDVO" resultType="int">	
		<![CDATA[
			SELECT COUNT(*)
			  FROM TB_EVENT A
   LEFT OUTER JOIN TB_FILE B
   			   	ON A.EVENT_NO = B.REF_NO
	   		   AND A.EVENT_DIV_CD = B.REF_DIV_CD
	   		   AND B.REF_TB_KEY = #{slyouthTbKey}
	   		 WHERE A.REP_IMG_NO != B.FILE_NO
	   		   AND A.EVENT_NO = #{eventNo}
		]]>
	</select>
	
	<!-- 동아리 상세 첨부파일 조회 -->
	<select id="selectCircleFile" parameterType="NtCircleDVO" resultType="NtCircleDVO">	
		<![CDATA[
			SELECT B.FILE_NO		/* 파일번호 */
			 	 , B.FILE_NM		/* 파일이름 */
			 	 , B.TMP_FILE_ID	/* 임시파일ID */
			  FROM TB_EVENT A
   LEFT OUTER JOIN TB_FILE B
   			   	ON A.EVENT_NO = B.REF_NO
	   		   AND A.EVENT_DIV_CD = B.REF_DIV_CD
	   		   AND B.REF_TB_KEY = #{slyouthTbKey}
	   		 WHERE A.REP_IMG_NO != B.FILE_NO
	   		   AND A.EVENT_NO = #{eventNo}
		]]>
	</select>
	
	<!-- 동아리 등록 -->
	<insert id="insertCircle"  parameterType="NtCircleDVO">
		<![CDATA[
		INSERT
		  INTO TB_EVENT
		  	   (	
		  	    EVENT_DIV_CD		/* 행사구분코드 */
		  	  , EVENT_NM			/* 행사명 */	
		  	  , EVENT_INTRO			/* 행사소개 */
		  	  , REP_IMG_NO			/* 행사이미지번호 */
		  	  , MNG_NO				/* 담당자번호 */
		  	  , STR_YMD				/* 시작일자 */
			  , PLACE				/* 장소 */
			  , REMARK				/* 비고 */
			  , FRS_REG_NO			/* 최초등록자번호 */
			  , FRS_REG_DT			/* 최초등록일자 */
			  , LST_MDF_NO			/* 최종수정자번호 */
			  , LST_MDF_DT			/* 최종수정일자 */
			   )
		VALUES (	
				'CIR'			
			  , #{eventNm}
			  , #{eventIntro}
			  , '0'
			  , '1'
			  , #{strYmd}
			  , #{place}
			  , #{remark}
			  , '1'
			  , NOW()
			  , '1'
			  , NOW()
			  )  
		]]>
		<selectKey keyProperty="eventNo" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<!-- 동아리 수정 -->
	<update id="updateCircle"  parameterType="NtCircleDVO">
		<![CDATA[
			UPDATE TB_EVENT
			   SET EVENT_NM = #{eventNm}			/* 행사명 */	
			  	 , EVENT_INTRO = #{eventIntro}		/* 행사소개 */
			  	 , MNG_NO = #{mngNo}				/* 담당자번호 */
			  	 , STR_YMD = #{strYmd}				/* 시작일자 */
			  	 , STR_TM = #{strTm}				/* 시작시각 */
				 , PLACE = #{place}					/* 장소 */
				 , REMARK = #{remark}				/* 비고 */
				 , LST_MDF_NO = '1'					/* 최종수정자번호 */
				 , LST_MDF_DT = NOW()				/* 최종수정일자 */
			 WHERE EVENT_NO = #{eventNo};
		]]>
	</update>
	
	<!-- 커뮤니티 관리테이블 동아리 등록 -->
	<insert id="insertCircleCmntyMng"  parameterType="NtCircleDVO">
		<![CDATA[
			INSERT
			  INTO TB_CMNTY_MNG
			  	   (	
			  	    CMNTY_DIV_CD		/* 커뮤니티구분코드(eventDivCd) */	
			  	  , CMNTY_NM			/* 커뮤니티이름(동아리 이름) */
				  , FRS_REG_NO			/* 최초등록자번호 */
				  , FRS_REG_DT			/* 최초등록일자 */
				  , LST_MDF_NO			/* 최종수정자번호 */
				  , LST_MDF_DT			/* 최종수정일자 */
				   )
			VALUES (	
					'CIR'			
				  , #{eventNm}
				  , '1'
				  , NOW()
				  , '1'
				  , NOW()
				   )  
		]]>
	</insert>
	
	<!-- 동아리 게시판 리스트 갯수 조회 -->
	<select id="selectCircleBoardListTotalCnt" parameterType="NtCircleDVO" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			  FROM TB_EVENT A
		INNER JOIN TB_CMNTY_MNG B
		        ON A.EVENT_NM = B.CMNTY_NM
   		INNER JOIN TB_CMNTY C
                ON B.CMNTY_MNG_NO = C.CMNTY_MNG_NO
               AND B.CMNTY_DIV_CD = C.CMNTY_DIV_CD
             WHERE B.CMNTY_DIV_CD = 'CIR'
               AND B.USE_YN = 'Y'
		       AND A.EVENT_NO = #{eventNo}
		]]>
	
		<if test="title != null and title != ''">
		<!-- 동아리 이름 -->
	   		   AND C.title LIKE CONCAT('%', #{title}, '%')
		</if>
	</select>
	
	<!-- 동아리 게시판 리스트 조회 -->
	<select id="selectCircleBoardList" parameterType="NtCircleDVO" resultType="NtCircleDVO">
	<include refid="cm.com.pagingTop" />
		<![CDATA[
			SELECT C.CMNTY_NO					/* 커뮤니티번호 */
				 , B.CMNTY_DIV_CD				/* 커뮤니티구분코드 */
				 , A.EVENT_DIV_CD
				 , C.TITLE						/* 제목 */
				 , C.CONTENT					/* 내용 */
				 , C.VIEW_CNT					/* 조회수 */
				 , (
				   	SELECT S1.NAME
				      FROM TB_CHRMGNT S1
				     WHERE S1.CHR_NO = C.LST_MDF_NO
				   ) NAME						/* 작성자 */
				 , C.LST_MDF_DT					/* 최종수정일시 */
			  FROM TB_EVENT A
		INNER JOIN TB_CMNTY_MNG B
		        ON A.EVENT_NM = B.CMNTY_NM
   		INNER JOIN TB_CMNTY C
                ON B.CMNTY_MNG_NO = C.CMNTY_MNG_NO
               AND B.CMNTY_DIV_CD = C.CMNTY_DIV_CD
             WHERE B.USE_YN = 'Y'
			   AND A.EVENT_NO = #{eventNo}
			   AND B.CMNTY_DIV_CD = 'CIR'
		  ORDER BY C.FRS_REG_DT DESC
		]]> 
	
		<if test="title != null and title != ''">
		<!-- 동아리 이름 -->
	   		   AND C.title LIKE CONCAT('%', #{title}, '%')
		</if>
		
	<include refid="cm.com.pagingBottom" />
	</select>
	
	<!-- 게시물 상세 조회수 수정 -->
	<update id="updateBoardViewCnt"  parameterType="NtCircleDVO">
		<![CDATA[
			UPDATE TB_CMNTY
			   SET VIEW_CNT = VIEW_CNT + 1
			 WHERE CMNTY_NO = #{cmntyNo}
		]]>
	</update>
	
	<!-- 동아리 게시판 상세 조회 -->
	<select id="selectCircleBoard" parameterType="NtCircleDVO" resultType="NtCircleDVO">
		<![CDATA[
			SELECT A.EVENT_NO					/* 이벤트번호 */
				 , A.EVENT_NM					/* 이벤트이름 */
				 , A.EVENT_DIV_CD				/* 이벤트구분코드 */
				 , B.CMNTY_DIV_CD				/* 커뮤니티구분코드 */
				 , B.CMNTY_MNG_NO				/* 커뮤니티 관리번호 */
				 , C.CMNTY_NO					/* 커뮤니티번호 */
				 , C.TITLE						/* 제목 */
				 , C.CONTENT					/* 내용 */
				 , C.VIEW_CNT					/* 조회수 */
				 , (
				   	SELECT S1.NAME
				      FROM TB_CHRMGNT S1
				     WHERE S1.CHR_NO = C.LST_MDF_NO
				   ) NAME						/* 작성자 */
				 , C.FRS_REG_DT					/* 최초등록일시 */
				 , C.LST_MDF_DT					/* 최종수정일시 */
			  FROM TB_EVENT A
		INNER JOIN TB_CMNTY_MNG B
		        ON A.EVENT_NM = B.CMNTY_NM
   LEFT OUTER JOIN TB_CMNTY C
                ON B.CMNTY_MNG_NO = C.CMNTY_MNG_NO
             WHERE B.USE_YN = 'Y'
               AND C.CMNTY_NO = #{cmntyNo}
               AND B.CMNTY_DIV_CD = 'CIR'
		]]>
	</select>
	
	<!-- 동아리 게시판 상세 파일 갯수 -->
	<select id="selectCircleBoardFileTotalCnt" parameterType="NtCircleDVO" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			  FROM TB_EVENT A
		INNER JOIN TB_CMNTY_MNG B
		        ON A.EVENT_NM = B.CMNTY_NM
		       AND B.USE_YN = 'Y'
   LEFT OUTER JOIN TB_CMNTY C
                ON B.CMNTY_MNG_NO = C.CMNTY_MNG_NO
   LEFT OUTER JOIN TB_FILE D
	   			ON C.CMNTY_NO = D.REF_NO
	   		   AND C.CMNTY_DIV_CD = D.REF_DIV_CD
	   		   AND D.REF_TB_KEY = #{slyouthTbKey}
             WHERE D.REF_NO = #{cmntyNo}
               AND C.CMNTY_DIV_CD = 'CIR'
		]]>
	
		<if test="title != null and title != ''">
		<!-- 동아리 이름 -->
	   		   AND C.title LIKE CONCAT('%', #{title}, '%')
		</if>
	</select>
	
	<!-- 동아리 게시판 상세 파일 조회 -->
	<select id="selectCircleBoardFile" parameterType="NtCircleDVO" resultType="NtCircleDVO">
		<![CDATA[
			SELECT C.CMNTY_NO					/* 커뮤니티번호 */
				 , B.CMNTY_DIV_CD				/* 커뮤니티구분코드 */
				 , D.FILE_NO					/* 파일 번호 */
				 , D.FILE_NM					/* 파일 이름 */
				 , D.REF_NO						/* 참조 번호 */
				 , D.REF_DIV_CD					/* 참조구분코드 */
				 , D.REF_TB_KEY					/* 참조키 */
				 , D.SAVE_PTH					/* 저장경로 */
				 , D.TMP_FILE_ID				/* 임시파일ID */
				 , C.FRS_REG_DT					/* 최초등록일시 */
				 , C.LST_MDF_DT					/* 최종수정일시 */
			  FROM TB_EVENT A
		INNER JOIN TB_CMNTY_MNG B
		        ON A.EVENT_NM = B.CMNTY_NM
		       AND B.USE_YN = 'Y'
   LEFT OUTER JOIN TB_CMNTY C
                ON B.CMNTY_MNG_NO = C.CMNTY_MNG_NO
   LEFT OUTER JOIN TB_FILE D
	   			ON C.CMNTY_NO = D.REF_NO
	   		   AND C.CMNTY_DIV_CD = D.REF_DIV_CD
	   		   AND D.REF_TB_KEY = #{slyouthTbKey}
             WHERE D.REF_NO = #{cmntyNo}
               AND C.CMNTY_DIV_CD = 'CIR'
		]]>
	
		<if test="title != null and title != ''">
		<!-- 동아리 이름 -->
	   		   AND C.title LIKE CONCAT('%', #{title}, '%')
		</if>
	</select>
	
	<!-- 동아리 게시판 등록 -->
	<insert id="insertCircleBoard"  parameterType="NtCircleDVO">
		<![CDATA[
			INSERT
			  INTO TB_CMNTY
			  	   (	
			  	    CMNTY_DIV_CD		/* 커뮤니티구분코드(eventDivCd) */	
			  	  , CMNTY_MNG_NO		/* 커뮤니티관리번호 */
			  	  , TITLE				/* 제목 */
			  	  , CONTENT				/* 내용 */	
				  , FRS_REG_NO			/* 최초등록자번호 */
				  , FRS_REG_DT			/* 최초등록일자 */
				  , LST_MDF_NO			/* 최종수정자번호 */
				  , LST_MDF_DT			/* 최종수정일자 */
				   )
			VALUES (	
					#{cmntyDivCd}			
				  , ( SELECT B.CMNTY_MNG_NO
				  		FROM TB_EVENT A
				  INNER JOIN TB_CMNTY_MNG B
				  		  ON A.EVENT_DIV_CD = B.CMNTY_DIV_CD
				  		 AND A.EVENT_NM = B.CMNTY_NM
				  	   WHERE B.CMNTY_DIV_CD = 'CIR'
					  	 AND A.EVENT_NO = #{eventNo}
				  	) 
				  , #{title}
				  , #{content}
				  , '1'
				  , NOW()
				  , '1'
				  , NOW()
				   )  
		]]>
		<selectKey keyProperty="cmntyNo" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
		
	<!-- 게시물 수정 -->
	<update id="updateCircleBoard"  parameterType="NtCircleDVO">
		<![CDATA[
			UPDATE TB_CMNTY
			   SET TITLE = #{title}				/* 제목 */
			  	 , CONTENT = #{content}			/* 내용 */	
				 , LST_MDF_DT = NOW()			/* 최종수정일자 */
			 WHERE CMNTY_NO = #{cmntyNo}
		]]>
	</update>
	
	<!-- 게시물 삭제 -->
	<delete id="deleteCircleBoard" parameterType="NtCircleDVO">
		<![CDATA[
			DELETE 
		  	  FROM TB_CMNTY
			 WHERE CMNTY_NO = #{cmntyNo}
		]]>
	</delete>
	
	<!-- 동아리 신청자 등록 -->
	<insert id="insertCircleAppMember"  parameterType="NtCircleDVO">
		<![CDATA[
			INSERT
			  INTO TB_EVENT_APP
			  	   (	
			  	    EVENT_NO			/* 행사번호(동아리번호) */	
				  , CHR_NO				/* 교적번호(신청자번호) */
				  , APP_YN				/* 승인여부 */
				   )
			VALUES (	
					#{eventNo}
				  , #{chrNo}
				  , 'Y'
				   )  
		]]>
	</insert>
	
	<!-- 동아리 신청자 리스트 갯수 조회 -->
	<select id="selectCircleAppMemberListTotalCnt" parameterType="NtCircleDVO" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			  FROM TB_EVENT A
   LEFT OUTER JOIN TB_EVENT_APP B
   				ON A.EVENT_NO = B.EVENT_NO
   			   AND A.EVENT_DIV_CD = 'CIR'
   			   AND B.APP_YN = 'Y'
   		INNER JOIN TB_CHRMGNT C
   		        ON B.CHR_NO = C.CHR_NO
   		     WHERE A.EVENT_NO = #{eventNo}
		]]>
	
	<if test="name != null and name != ''">
	<!-- 동아리 이름 -->
   		   AND B.NAME LIKE CONCAT('%', #{name}, '%')
	</if>
	</select>
	
	<!-- 동아리 신청자 리스트 조회 -->
	<select id="selectCircleAppMemberList" parameterType="NtCircleDVO" resultType="NtCircleDVO">
		<![CDATA[
			SELECT C.CHR_NO					/* 교적번호 */
				 , C.NAME					/* 이름 */
				 , A.MNG_NO					/* 담당자번호 */
			  FROM TB_EVENT A
   LEFT OUTER JOIN TB_EVENT_APP B
   				ON A.EVENT_NO = B.EVENT_NO
   			   AND A.EVENT_DIV_CD = 'CIR'
   			   AND B.APP_YN = 'Y'
   LEFT OUTER JOIN TB_CHRMGNT C
   		        ON B.CHR_NO = C.CHR_NO
   		     WHERE A.EVENT_NO = #{eventNo}
		]]>
	
	<if test="name != null and name != ''">
	<!-- 동아리 이름 -->
   		   AND B.NAME LIKE CONCAT('%', #{name}, '%')
	</if>
	</select>
	
</mapper>