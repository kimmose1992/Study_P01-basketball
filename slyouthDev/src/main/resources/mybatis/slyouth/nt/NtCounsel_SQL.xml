<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="nt.counsel">

	<!-- 상담 목록 건수를 조회하는 쿼리입니다. -->
	<select id="selectCounselTotalDataCnt" parameterType="NtCounselDVO" resultType="int">
	<![CDATA[
		SELECT COUNT(*)
		  FROM TB_CMNTY AS R1
    INNER JOIN TB_CHRMGNT AS R2
            ON R1.LST_MDF_NO = R2.CHR_NO
     LEFT JOIN TB_FILE R3
      		ON R1.TSK_DIV_CD = R3.REF_TB_KEY
      	   AND R1.CMNTY_NO = R3.REF_NO
      	 WHERE R1.CMNTY_DIV_CD = 'CNS'
      		
	]]>
	<if test="title != null and title != ''">
		    <!-- 제목 -->
		    AND R1.TITLE LIKE CONCAT('%', #{title}, '%')	
	</if>

	<if test="content != null and content != ''">
			<!-- 내용 -->
			AND R1.CONTENT LIKE CONCAT('%', #{content}, '%')
	</if>

	<if test="name != null and name != ''">
			<!-- 작성자 -->
			AND R2.NAME LIKE CONCAT('%', #{name}, '%')
	</if>	
	</select>

	<!-- 상담 리스트를 조회하는 쿼리입니다. -->
	<select id="counselList" parameterType="NtCounselDVO" resultType="NtCounselDVO">

	<include refid="cm.com.pagingTop" />	
	
	<![CDATA[
		SELECT CMNTY_NO         /* 커뮤니티번호 */   
		     , CONTENT          /* 내용 */    
		     , VIEW_CNT         /* 조회수 */   
		     , OPEN_YN          /* 공개여부 */
		     , TITLE            /* 제목 */   
		     , ANNY_YN          /* 익명여부 */  
		     , NAME             /* 이름 */    
		     , GRP_NO           /* 그룹번호 */  
		     , GRP_ORD          /* 그룹순서 */  
		     , FILE_NO          /* 파일번호 */  
		     , LST_MDF_DT       /* 최종수정일시 */
		  FROM (
		       	SELECT R1.CMNTY_NO						
					 , R1.CONTENT			
				     , R1.VIEW_CNT 			
				     , R1.OPEN_YN
				     , CASE R1.OPEN_YN
				       	WHEN 'Y' THEN R1.TITLE
				       	ELSE CONCAT('비밀 글 : ', R1.TITLE)	
				       END AS TITLE	
				     , R1.ANNY_YN
				     , CASE R1.ANNY_YN
				       	WHEN 'N' THEN R2.NAME
				       	ELSE '익명'
				       END AS NAME  			
				     , R1.GRP_NO			
				     , R1.GRP_ORD			   				
				     , R3.FILE_NO			
				     , R1.LST_MDF_DT		
				  FROM TB_CMNTY AS R1 
			INNER JOIN TB_CHRMGNT AS R2
					ON R1.LST_MDF_NO = R2.CHR_NO
			 LEFT JOIN TB_FILE R3
				    ON R1.TSK_DIV_CD = R3.REF_TB_KEY
				   AND R1.CMNTY_NO = R3.REF_NO
				 WHERE R1.CMNTY_DIV_CD = 'CNS'			 
	]]>
	<if test="title != null and title != ''">
				   <!-- 제목 -->
		   		   AND R1.TITLE LIKE CONCAT('%', #{title}, '%')	
	</if>

	<if test="content != null and content != ''">
				   <!-- 내용 -->
				   AND R1.CONTENT LIKE CONCAT('%', #{content}, '%')
	</if>

	<if test="name != null and name != ''">
				   <!-- 작성자 -->
			       AND R2.NAME LIKE CONCAT('%', #{name}, '%')
	</if>	
			  ) A
	   ORDER BY GRP_NO DESC
			  ,	GRP_ORD ASC
		  LIMIT 100000
	<include refid="cm.com.pagingBottom" />
	</select>

	<!-- 상담 커뮤니티번호에 맞는 정보들을 조회하는 쿼리입니다. -->
	<select id="counselDetail" parameterType="NtCounselDVO" resultType="NtCounselDVO">
	<![CDATA[
		SELECT R1.CMNTY_NO 				/* 커뮤니티번호 */
			 , R1.MNG_NO 				/* 담당자번호 */
			 , R1.TITLE 				/* 제목 */
			 , R1.CONTENT 				/* 내용 */
			 , R1.VIEW_CNT 				/* 조회수 */
			 , R1.OPEN_YN 				/* 공개여부 */
			 , R1.ANNY_YN 				/* 익명여부 */
			 , R1.GRP_NO 				/* 그룹번호 */
			 , R1.GRP_ORD 				/* 그룹순서 */
			 , R2.NAME 					/* 이름 */
			 , R3.FILE_NO 				/* 파일번호 */
			 , (
		   		SELECT NAME
		     	  FROM TB_CHRMGNT
		     	 WHERE CHR_NO = R1.MNG_NO
		  		) AS MNG_NM 			/* 담당자이름 */
			 , R1.FRS_REG_DT 			/* 최초등록일시 */
			 , R1.LST_MDF_DT 			/* 최종수정일시 */
		  FROM TB_CMNTY AS R1
	INNER JOIN TB_CHRMGNT AS R2
		    ON R1.LST_MDF_NO = R2.CHR_NO
	 LEFT JOIN TB_FILE R3
			ON R1.TSK_DIV_CD = R3.REF_TB_KEY
		   AND R1.CMNTY_NO = R3.REF_NO
		 WHERE R1.CMNTY_DIV_CD = 'CNS'
		   AND R1.CMNTY_NO = #{cmntyNo}
	]]>
	</select>

	<!-- 상담 같은 그룹번호의 글의 수를 조회하는 쿼리입니다. -->
	<select id="counselCount" parameterType="NtCounselDVO" resultType="int">
	<![CDATA[
		SELECT COUNT(GRP_NO)
		  FROM TB_CMNTY
		 WHERE GRP_NO = #{grpNo}
		   AND CMNTY_DIV_CD = 'CNS'
	]]>
	</select>

	<!-- 상담 본 글을 등록하는 쿼리입니다. -->
	<insert id="counselRegist" parameterType="NtCounselDVO">
	<selectKey keyProperty="grpNo" resultType="int" order="BEFORE">
		SELECT IFNULL(MAX(GRP_NO) + 1, 1)
		  FROM TB_CMNTY
		 WHERE CMNTY_DIV_CD = 'CNS'
	</selectKey>
	
	<![CDATA[
		INSERT 
		  INTO TB_CMNTY
			   (	
			   		TITLE				/* 제목 */
			   		, CONTENT			/* 내용 */
			   		, FRS_REG_NO		/* 최초등록자 */
			   		, LST_MDF_NO		/* 최종수정자 */
			   		, ANNY_YN			/* 익명여부 */
			   		, OPEN_YN			/* 공개여부 */
			   		, TSK_DIV_CD		/* 업무구분코드 */
			   		, CMNTY_DIV_CD		/* 커뮤니티구분코드 */
			   		, GRP_NO			/* 그룹번호 */
			   		, MNG_NO			/* 담당자번호 */
			   	)
		VALUES	(
					#{title}
					, #{content}
					, '1'
					, '1'
					, #{annyYn}
					, #{openYn}
					, 'CB'
					, 'CNS'
					, #{grpNo}
					, #{mngNo}
				)
	]]>
	</insert>

	<!-- 상담 글을 수정하는 쿼리입니다. -->
	<update id="counselUpdate" parameterType="NtCounselDVO">
	<![CDATA[
		UPDATE TB_CMNTY 
		   SET TITLE = #{title}			/* 제목 */
			 , CONTENT = #{content}		/* 내용 */
			 , LST_MDF_DT = NOW()		/* 최종수정일시 */		
		 WHERE CMNTY_NO = #{cmntyNo}
		   AND CMNTY_DIV_CD = 'CNS';
	]]>
	</update>
	
	<!-- 상담 본 글인 경우 익명, 공개여부는 답글도 수정되는 쿼리입니다. --> 
	<update id="counselSubUpdate" parameterType="NtCounselDVO">
	<![CDATA[
		UPDATE TB_CMNTY
		   SET ANNY_YN = #{annyYn}		/* 익명여부 */
		   	 , OPEN_YN = #{openYn}		/* 공개여부 */
		   	 , MNG_NO = #{mngNo}		/* 담당자번호 */
		 WHERE GRP_NO = #{grpNo}
		   AND CMNTY_DIV_CD = 'CNS';
	]]>
	</update>

	<!-- 상담 답글을 등록하는 쿼리입니다. -->
	<insert id="counselReply" parameterType="NtCounselDVO">
	<selectKey keyProperty="grpOrd" resultType="int" order="BEFORE">
		SELECT IFNULL(MAX(GRP_ORD) + 1, 0)
		  FROM TB_CMNTY
		 WHERE CMNTY_DIV_CD = 'CNS'
		   AND GRP_NO = #{grpNo}
	</selectKey>
	
	<![CDATA[
		INSERT 
		  INTO TB_CMNTY
			   (	TITLE				/* 제목 */
			   		, CONTENT			/* 내용 */
			   		, FRS_REG_NO		/* 최초등록자 */
			   		, LST_MDF_NO		/* 최종수정자 */
			   		, OPEN_YN			/* 공개여부 */
			   		, ANNY_YN			/* 익명여부 */
			   		, TSK_DIV_CD		/* 업무구분코드 */
			   		, CMNTY_DIV_CD		/* 커뮤니티구분코드 */
			   		, GRP_NO			/* 그룹번호 */
			   		, GRP_ORD			/* 그룹순서 */
			   		, MNG_NO			/* 담당자번호 */
			   	)
		VALUES	(
					#{title}
					, #{content}
					, '1'
					, '1'
					, #{openYn}
					, #{annyYn}
					, 'CB'
					, 'CNS' 
					, #{grpNo}
					, #{grpOrd}
					, #{mngNo}
				)
	]]>
	</insert>

	<!-- 상담 글을 삭제하는 쿼리입니다. -->
	<delete id="counselDelete" parameterType="NtCounselDVO">
	<![CDATA[
		DELETE 
		  FROM TB_CMNTY
		 WHERE CMNTY_NO	= #{cmntyNo}
		   AND CMNTY_DIV_CD = 'CNS'
	]]>
	</delete>

</mapper>