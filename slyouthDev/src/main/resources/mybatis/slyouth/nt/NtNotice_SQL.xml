<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="nt.ntc">
	
	<!-- 공지사항(NTC) 상단글 조회 -->
   	<select id="ntNoticeTopList" resultType="NtNoticeDVO">
   	<![CDATA[
 		 SELECT A1.CMNTY_NO              	/* 커뮤니티번호*/
              , A1.TITLE                 	/* 제목 */
              , A1.CONTENT               	/* 내용 */
              , A1.FRS_REG_DT            	/* 최초등록일시 */
              , A1.LST_MDF_DT            	/* 최종수정일시 */
              , A1.VIEW_CNT              	/* 조회수 */
              , A1.TOP_FIX_YN            	/* 상단고정여부 */
              , A1.CMNTY_DIV_CD          	/* 커뮤니티구분코드 */
              , A1.WRT_DIV_CD            	/* 글구분코드 */
              , A1.FRS_REG_NO            	/* 최초등록자번호 */
              , A1.LST_MDF_NO				/* 최종수정자번호*/
              , A2.CHR_NO 					/* 교적번호 */
              , A2.NAME						/* 이름 */						
           FROM TB_CMNTY AS A1
	 INNER JOIN TB_CHRMGNT AS A2
	         ON A1.FRS_REG_NO = A2.CHR_NO 	
          WHERE A1.TOP_FIX_YN = "Y"
            AND A1.CMNTY_DIV_CD = "NTC"
       ORDER BY A1.LST_MDF_DT DESC
            
	]]>
	
	<if test="title != null and title != ''">
    <!-- 제목 -->   
		AND TITLE LIKE CONCAT('%', #{title}, '%')
    </if>
    
	</select>
	
	<!-- 공지사항(NTC) 일반글 조회 -->
   	<select id="ntNoticeList" parameterType="NtNoticeDVO" resultType="NtNoticeDVO">
   	<include refid="cm.com.pagingTop" />
   	
   	<![CDATA[
 		 SELECT A1.CMNTY_NO              	/* 커뮤니티번호*/
              , A1.TITLE                 	/* 제목 */
              , A1.CONTENT               	/* 내용 */
              , A1.FRS_REG_DT            	/* 최초등록일시 */
              , A1.LST_MDF_DT            	/* 최종수정일시 */
              , A1.VIEW_CNT              	/* 조회수 */
              , A1.TOP_FIX_YN            	/* 상단고정여부 */
              , A1.CMNTY_DIV_CD          	/* 커뮤니티구분코드 */
              , A1.WRT_DIV_CD            	/* 글구분코드 */
              , A1.FRS_REG_NO            	/* 최초등록자번호 */
              , A1.LST_MDF_NO				/* 최종수정자번호*/
              , A2.CHR_NO 					/* 교적번호 */
              , A2.NAME						/* 이름 */						
           FROM TB_CMNTY AS A1
	 INNER JOIN TB_CHRMGNT AS A2
	         ON A1.FRS_REG_NO = A2.CHR_NO 	
          WHERE A1.TOP_FIX_YN = "N"
            AND A1.CMNTY_DIV_CD = "NTC"
       ORDER BY A1.LST_MDF_DT DESC
	]]>
	
	<if test="title != null and title != ''">
    <!-- 제목 -->   
		AND TITLE LIKE CONCAT('%', #{title}, '%')
    </if>
    
	<include refid="cm.com.pagingBottom" />
	</select>
	
	<!-- 공지사항(NTC) 메인 공지사항 리스트 -->
	<select id="ntNoticeSubList" resultType="NtNoticeDVO">
	<![CDATA[
		SELECT CMNTY_NO				/* 커뮤니티번호*/
		     , TITLE            	/* 제목 */
		     , FRS_REG_DT       	/* 최초등록일시 */
		     , CONTENT				/* 내용 */
          FROM TB_CMNTY
         WHERE CMNTY_DIV_CD = "NTC"
         ORDER BY LST_MDF_DT DESC
         LIMIT 3
	]]>
	</select>
	
	<!-- 공지사항(NTC) 상세조회 -->
   	<select id="ntNoticeDetail" parameterType="NtNoticeDVO" resultType="NtNoticeDVO">
   	<![CDATA[ 
   		 SELECT A1.CMNTY_NO              	/* 커뮤니티번호*/
              , A1.TITLE                 	/* 제목 */
              , A1.CONTENT               	/* 내용 */
              , A1.FRS_REG_DT            	/* 최초등록일시 */
              , A1.LST_MDF_DT            	/* 최종수정일시 */
              , A1.VIEW_CNT              	/* 조회수 */
              , A1.TOP_FIX_YN            	/* 상단고정여부 */
              , A1.CMNTY_DIV_CD          	/* 커뮤니티구분코드 */
              , A1.WRT_DIV_CD            	/* 글구분코드 */
              , A1.FRS_REG_NO            	/* 최초등록자번호 */
              , A1.LST_MDF_NO				/* 최종수정자번호*/
              , A2.CHR_NO 					/* 교적번호 */
              , A2.NAME						/* 이름 */						
           FROM TB_CMNTY AS A1
	 INNER JOIN TB_CHRMGNT AS A2
	         ON A1.FRS_REG_NO = A2.CHR_NO 	
          WHERE A1.CMNTY_DIV_CD = "NTC"
            AND A1.CMNTY_NO = #{cmntyNo}
	]]>
	</select>
	
	
	<!-- 공지사항 목록 갯수 조회 -->
   	<select id="selectNoticeTotalCnt" parameterType="NtNoticeDVO" resultType="int">
   	<![CDATA[
 		 SELECT COUNT (*)
           FROM TB_CMNTY
          WHERE CMNTY_DIV_CD = "NTC"
	]]>
	
	<if test="title != null and title != ''">
    <!-- 제목 -->   
		AND TITLE LIKE CONCAT('%', #{title}, '%')
    </if>
    
	</select>
	
	<!-- 공지사항(NTC) 조회수 증가 -->
	<update id="ntNoticeCnt" parameterType="int">
	<![CDATA[
		UPDATE TB_CMNTY
		   SET VIEW_CNT = VIEW_CNT + 1			/* 조회수 */
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>
	</update>
	
	<!-- 공지사항(NTC) 글 등록 -->
	<insert id="ntNoticeInsert"  parameterType="NtNoticeDVO">
	<![CDATA[
		INSERT
		  INTO TB_CMNTY
		  	   (	
		  	    TITLE				/* 제목 */
		  	  , CONTENT				/* 내용 */	
			  , VIEW_CNT			/* 조회수 */ 
			  , CMNTY_DIV_CD		/* 커뮤니티구분코드 */
			  , WRT_DIV_CD			/* 글구분코드 */
			  , FRS_REG_NO			/* 최초등록자 */
			  , LST_MDF_NO			/* 최종수정자 */
			  , TOP_FIX_YN			/* 상단고정여부 */
			  , FRS_REG_DT			/* 최초등록일시 */
			  , LST_MDF_DT			/* 최종수정일시*/
			  , GRP_NO				/* 그룹번호 */	
			  			
			   )
		VALUES (	
				#{title}			
			  , #{content}
			  , #{viewCnt}
			  , 'NTC'
			  , 'NTC'
			  , '1'			  
			  , #{lstMdfNo}
			  , #{topFixYn}
			  , NOW()
			  , NOW()
			  , (
					SELECT CMNTY_NO
					  FROM TB_CMNTY ALIAS_FOR_SUBQUERY
				  ORDER BY CMNTY_NO DESC
				     LIMIT 1
				) + 1
			   )  
		]]>
		<selectKey keyProperty="cmntyNo" resultType="int">
	        SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	<!-- 공지사항 수정 -->
	<update id="ntNoticeUpdate" parameterType="NtNoticeDVO">
	<![CDATA[
		UPDATE TB_CMNTY
		   SET TITLE = #{title}					/* 제목 */		
		     , CONTENT = #{content}				/* 내용 */
		   	 , TOP_FIX_YN = #{topFixYn}			/* 상단고정여부 */
		   	 , LST_MDF_DT = NOW()				/* 최종수정일시 */
		   	 , LST_MDF_NO = #{lstMdfNo}					/* 최종수정자 */
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>
	</update>
	
	<!-- 공지사항 삭제 -->
	<delete id="ntNoticeDelete" parameterType="int">
	<![CDATA[
		DELETE FROM 
			   TB_CMNTY
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>
	</delete>
</mapper>