<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="nt.chat">
	
	<!-- 자유게시판에서 입력된 정보로 조회된 데이터의 건수를 리턴하는 쿼리입니다. -->
	<select id="selectChatTotalDataCnt" parameterType="NtChatDVO" resultType="int">
	<![CDATA[
		SELECT COUNT(*)
		  FROM TB_CMNTY A 
	INNER JOIN TB_CHRMGNT B
			ON A.LST_MDF_NO = B.CHR_NO
		 WHERE A.CMNTY_DIV_CD = 'CHT'
	]]>
	
	<if test="title != null and title != ''">
		   <!-- 제목 -->
		   AND A.TITLE LIKE CONCAT('%', #{title}, '%')
	</if>
	<if test="name != null and name != ''">
		   <!-- 작성자 -->
		   AND B.NAME LIKE CONCAT('%', #{name}, '%')	
	</if>
	</select>
	
	<!-- 자유게시판에서 입력된 정보로 데이터를 리스트 형태로 조회하는 쿼리입니다. -->
	<select id="selectChatList" resultType="NtChatDVO">
	<include refid="cm.com.pagingTop" />

	<![CDATA[
		SELECT A.CMNTY_NO									/* 커뮤니티번호 */
			 , A.WRT_DIV_CD									/* 작성구분코드 */
			 , (SELECT CD_NM
			      FROM TB_CODE
			     WHERE CD_GRP_ID = 'CHAT_DIV_CD'
			       AND CD_VL = A.WRT_DIV_CD) AS WRT_DIV_NM	/* 작성구분 */
			 , A.TITLE										/* 제목 */
			 , A.CONTENT									/* 내용 */
		     , A.LST_MDF_DT									/* 최종수정일시 */
		     , A.VIEW_CNT 									/* 조회수 */
		     , B.NAME										/* 이름 */
		  FROM TB_CMNTY A 									/* TB_커뮤니티 */
	INNER JOIN TB_CHRMGNT B									/* TB_교적관리 */
			ON A.LST_MDF_NO = B.CHR_NO
		 WHERE A.CMNTY_DIV_CD = 'CHT'
	]]>
	  
	<if test="wrtDivCd != null and wrtDivCd != ''">
		   <!-- 자유게시판 구분 -->
		   AND A.WRT_DIV_CD = #{wrtDivCd}
	</if>
	<if test="title != null and title != ''">
		   <!-- 제목 -->
		   AND A.TITLE LIKE CONCAT('%', #{title}, '%')
	</if>
	<if test="name != null and name != ''">
		   <!-- 작성자 -->
		   AND B.NAME LIKE CONCAT('%', #{name}, '%')	
	</if>
	  
	<include refid="cm.com.pagingBottom" />
	</select>
	
	<!-- 자유게시판에서 입력된 정보로 데이터를 상세조회하는 쿼리입니다. -->
	<select id="selectChatInfo" parameterType="NtChatDVO" resultType="NtChatDVO">
	<![CDATA[
		SELECT A.CMNTY_NO								/* 커뮤니티번호 */
			 , A.WRT_DIV_CD								/* 작성구분코드 */
			 , A.TITLE									/* 제목 */
			 , A.CONTENT								/* 내용 */
		     , A.VIEW_CNT 								/* 조회수 */
		     , B.NAME									/* 이름 */
		     , (SELECT NICKNAME
		          FROM TB_USER
		         WHERE USR_ID = B.USR_ID) AS NICKNAME	/* 닉네임 */
		     , A.LST_MDF_DT								/* 최종수정일시 */
		  FROM TB_CMNTY A 								/* TB_커뮤니티 */
	INNER JOIN TB_CHRMGNT B								/* TB_교적관리 */
			ON A.LST_MDF_NO = B.CHR_NO
		 WHERE A.CMNTY_DIV_CD = 'CHT'
		   AND A.CMNTY_NO = #{cmntyNo}
	]]>		
	</select>
	
	<!-- 자유게시판에서 입력된 정보로 게시물을 등록하는 쿼리입니다. -->
	<insert id="insertChatInfo" parameterType="NtChatDVO">
	<![CDATA[
		INSERT 
		  INTO TB_CMNTY
			   (	
			    CMNTY_MNG_NO	/* 커뮤니티관리번호 */
			  , WRT_DIV_CD		/* 작성구분 */
			  , TITLE			/* 제목 */
	   		  , CONTENT			/* 내용 */
	   		  , FRS_REG_NO		/* 최초등록자 */
	   		  , LST_MDF_NO		/* 최종수정자 */
	   		  , CMNTY_DIV_CD	/* 커뮤니티구분코드 */
			   )
		VALUES (
				( SELECT CMNTY_MNG_NO
				    FROM TB_CMNTY_MNG
				   WHERE CMNTY_DIV_CD = 'CHT' )
			  ,	#{wrtDivCd}
			  , #{title}
			  , #{content}
			  , #{chrNo}
			  , #{chrNo}
			  , 'CHT'
			   )
	]]>
	</insert>
	
	<!-- 자유게시판에서 입력된 정보로 게시물을 수정하는 쿼리입니다. -->
	<update id="updateChatInfo" parameterType="NtChatDVO">
	<![CDATA[
		UPDATE TB_CMNTY					/* TB_커뮤니티 */
		   SET WRT_DIV_CD = #{wrtDivCd}	/* 작성구분 */
		     , TITLE = #{title} 		/* 제목 */
		   	 , CONTENT = #{content}		/* 내용 */
		   	 , LST_MDF_NO = #{chrNo}	/* 최종수정자 */
		   	 , LST_MDF_DT = NOW()		/* 최종수정일시 */
		 WHERE CMNTY_NO = #{cmntyNo}
		   AND CMNTY_DIV_CD = 'CHT'
	]]>
	</update>
	
	<!-- 자유게시판에서 입력된 정보로 게시물을 삭제하는 쿼리입니다. -->
	<delete id="deleteChatInfo" parameterType="NtChatDVO">
	<![CDATA[
		DELETE 
		  FROM TB_CMNTY
		 WHERE CMNTY_NO = #{cmntyNo}
	]]>	
	</delete>
	
	<!-- 댓글에서 데이터를 리스트 형태로 조회하는 쿼리입니다. -->
	<select id="commentList" resultType="NtCommentDVO">
	<![CDATA[
		SELECT A.COMMENT_NO			/* 댓글번호 */
			 , A.REF_NO				/* 참조번호 */
			 , A.CONTENT			/* 내용 */
		     , A.LST_MDF_DT			/* 최종수정일시 */
		     , B.NAME				/* 이름 */
		  FROM TB_COMMENT AS A 
	INNER JOIN TB_CHRMGNT AS B
			ON A.LST_MDF_NO = B.CHR_NO
		 WHERE A.REF_DIV_CD = 'CHT'
		   AND A.REF_NO = #{cmntyNo};
	]]>
	</select>
	
	<!-- 입력된 정보로 댓글을 등록하는 쿼리입니다. -->
	<insert id="commentRegist" parameterType="NtCommentDVO">
	<selectKey keyProperty="grpNo" resultType="int" order="BEFORE">
		SELECT IFNULL(MAX(GRP_NO) + 1, 1)
		  FROM TB_COMMENT
		 WHERE REF_DIV_CD = 'CHT'
		   AND REF_NO = #{refNo}
	</selectKey>
	<![CDATA[
		INSERT 
		  INTO TB_COMMENT
			   (	
			   		REF_NO				/* 참조번호 */
			   		, REF_DIV_CD		/* 참조구분코드 */
			   		, REF_TB_KEY		/* 참조테이블키 */
			   		, CONTENT			/* 내용 */
			   		, GRP_NO			/* 그룹번호 */
			   		, FRS_REG_NO		/* 최초등록자 */
			   		, LST_MDF_NO		/* 최종수정자 */
			   	)
		VALUES	(
					#{refNo}
					, 'CHT'
					, 'CHT'
					, #{content}
					, #{grpNo}
					, '1'
					, '1'
				)
	]]>
	</insert>
	
	<!-- 입력된 정보로 댓글을 삭제하는 쿼리입니다. -->
	<delete id="commentDelete" parameterType="NtCommentDVO">
	<![CDATA[
		DELETE FROM
			   TB_COMMENT
		 WHERE COMMENT_NO = #{commentNo}
	]]>	
	</delete>
</mapper>