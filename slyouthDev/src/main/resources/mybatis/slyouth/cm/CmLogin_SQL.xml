<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cm.login">

	<!-- 본인인증 교적확인 -->
	<select id="selectCertMember" parameterType="CmLoginDVO" resultType="CmLoginDVO">
	<![CDATA[
		SELECT A.CHR_NO						/* 교적번호 */
			 , A.USR_ID						/* 사용자ID */
			 , A.CHR_DIV_CD					/* 교적구분코드 */ 
			 , A.POS_DIV_CD					/* 직책구분코드 */ 
  		  FROM TB_CHRMGNT A					/* TB_교적관리 */
 		 WHERE A.NAME = #{certName} 
 		   AND A.BIRTH = #{certBirth} 
 		   AND A.MB_TEL_NO = #{certPhone}
	]]>	
	</select>
	
	<!-- 본인인증 정보 저장 -->
	<insert id="saveAuthInfo" parameterType="CmLoginDVO">
	<![CDATA[
		INSERT 
		  INTO TB_AUTH_NO
		       (
		      	NAME				/* 이름 */
		      , BIRTH				/* 생년월일 */
		      , MB_TEL_NO			/* 핸드폰번호 */
		      , AUTH_NO_ENCRYPT		/* 인증번호암호화 */
		       )
		VALUES (
			  	#{certName}
			  , #{certBirth}
			  , #{certPhone}
			  , #{authNoEncrypt}
			   )
		    ON DUPLICATE KEY 
		UPDATE AUTH_NO_ENCRYPT = #{authNoEncrypt};    			   			 
	]]>
	</insert>

	<!-- 본인인증 확인 -->
	<select id="selectAuthInfo" parameterType="CmLoginDVO" resultType="CmLoginDVO">
	<![CDATA[
		SELECT AUTH_NO_ENCRYPT			/* 인증번호암호화 */
		  FROM TB_AUTH_NO
 		 WHERE NAME = #{certName} 
 		   AND BIRTH = #{certBirth} 
 		   AND MB_TEL_NO = #{certPhone}
	]]>	
	</select>
	
	<!-- 회원가입 -->
	<insert id="insertUser" parameterType="CmLoginDVO">
	<![CDATA[
		INSERT 
		  INTO TB_USER
		       (
		      	USR_ID				/* 사용자ID */
		      , USR_PW				/* 사용자PW */
		      , USR_ROLE			/* 사용자권한 */
		      , NICKNAME			/* 닉네임 */
		      , ACNT_ST_CD			/* 계정상태코드 */
		      , PW_ERR_CNT			/* 패스워드오류횟수 */
		      , LOGIN_CNT			/* 로그인횟수 */
		      , FRS_REG_NO			/* 최초등록자번호 */
		      , LST_MDF_NO			/* 최종수정자번호 */
		       )
		VALUES (
			  	#{usrId}
			  , #{usrPw}
			  , #{usrRole}
			  , #{nickname}
			  , 'ACT'
			  , #{pwErrCnt}
			  , #{loginCnt}
			  , '1'
			  , '1'
			   )
	]]>
	</insert>
	
	<!-- 사용자 정보 조회 -->
	<select id="findByUsrId" parameterType="CmLoginDVO" resultType="CmLoginDVO">
	<![CDATA[
		SELECT A.USR_NO 
			 , A.USR_ID				/* 사용자ID */
     		 , A.USR_PW				/* 사용자PW */
     		 , A.USR_ROLE			/* 사용자권한 */
     		 , B.NAME AS USR_NM		/* 사용자이름 */
     		 , B.CHR_NO				/* 교적번호 */
     		 , A.ACNT_ST_CD			/* 계정상태코드 */
     		 , A.NICKNAME			/* 닉네임 */
     		 , A.LOGIN_CNT			/* 로그인횟수 */
     		 , A.PW_ERR_CNT			/* 패스워드오류횟수 */
     		 , A.FRS_REG_NO			/* 최초등록자번호 */
		 	 , A.FRS_REG_DT			/* 최초등록일시 */
			 , A.LST_MDF_NO			/* 최종수정자번호 */
			 , A.LST_MDF_DT			/* 최종수정일시 */
  		  FROM TB_USER A 
    INNER JOIN TB_CHRMGNT B
    	   	ON A.USR_ID = B.USR_ID
 		 WHERE A.USR_ID = #{usrId} 
	]]>	
	</select>
	
	<!-- 계정 잠금 -->
	<update id="updateLoginInfoLock" parameterType="CmLoginDVO">
	<![CDATA[
		UPDATE TB_USER
		   SET ACNT_ST_CD = 'DSB'
		     , LST_MDF_DT = NOW()
		 WHERE USR_ID = #{usrId}
	]]>		
	</update>
	
	<!-- 계정 해제 -->
	<update id="updateLoginInfoUnlock" parameterType="CmLoginDVO">
	<![CDATA[
		UPDATE TB_USER
		   SET ACNT_ST_CD = 'ACT'
		     , LST_MDF_DT = NOW()
		 WHERE USR_ID = #{usrId}
	]]>		
	</update>
	
	<!-- 비밀번호 변경 -->
	<update id="updatePassword" parameterType="CmLoginDVO">
	<![CDATA[
		UPDATE TB_USER
		   SET USR_PW = #{usrPw}
		     , LST_MDF_DT = NOW()
		 WHERE USR_ID = ( 
		 				  SELECT USR_ID
		 				    FROM TB_CHRMGNT
		 				   WHERE CHR_NO = #{chrNo} 
		 				 )
	]]>
	</update>
		
	<!-- 비밀번호 오류 횟수 수정 -->
	<update id="updatePwErrCnt" parameterType="CmLoginDVO">
	<![CDATA[
		UPDATE TB_USER
		   SET LST_MDF_DT = NOW() 
	]]>
	
	<choose>
		<!-- 로그인 성공 시 0으로 초기화 -->
		<when test="isLoginPass == true">
		     , PW_ERR_CNT = 0		
		</when>
		<!-- 로그인 실패 시(비밀번호 오류) 오류 횟수 증가 -->
		<otherwise>
		     , PW_ERR_CNT = PW_ERR_CNT + 1			
		</otherwise>
	</choose>
	
	<![CDATA[		      
		 WHERE USR_ID = #{usrId}
	]]>		 
	</update>
	
	<!-- 로그인 횟수 수정 -->
	<update id="updateLoginCnt" parameterType="CmLoginDVO">
	<![CDATA[
		UPDATE TB_USER
		   SET LOGIN_CNT = LOGIN_CNT + 1
		     , LST_MDF_DT = NOW()
		 WHERE USR_ID = #{usrId}
	]]>
	</update>
	
	<!-- Id 확인 -->
	<select id="checkId" parameterType="CmLoginDVO" resultType="CmLoginDVO">
	<![CDATA[
		SELECT USR_NO					/* 유저번호 */
		  FROM TB_USER
 		 WHERE USR_ID = #{usrId}
	]]>	
	</select>
</mapper>